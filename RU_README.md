## UniFi Miner

Это небольшой инструмент для получения оперативных данных от контроллера в виде, пригодном для использования в Zabbix.
C его помощью можно передать в систему мониторинга любые показатели и настройки, доступные через API, предоставленный компанией Ubiquiti. 

# Использование

unifi_miner.pl [-o object] [-i id | -m mac] [-k key] [-l location] [-s site] [-u username] [-p password] [-v controller_ver] [-a action] [-d debug_level] [-n null_replacer] [-c sec]

где:

-o [ wlan ] тип исследуемого объекта: `uap`, `wlan`, иные;
-i внутренний ID объекта;
-m MAC-адрес объекта;
-k ключ метрики, значение которой необходимо получить;
-l [ https://127.0.0.1:8443 ] местонахождение интерфейса контроллера;
-s [ default ] имя сайта, существующего в контроллере UniFi;
-u [ stat ] имя пользователя для доступа к контроллеру через API;
-p [ stat ] пароль пользователя для доступа к контроллеру;
-v [ v4 ] версия контроллера: `v2`, `v3`, `v4`;
-a [ count ] действие, производимое над метриками в том случае, если обрабатывается список объектов (например - все UAP): `count`, `sum`;
-d [ 0 ] - уровень отладки: 0..3;
-n заменитель значения JSON:null;
-c время устаревания кэшированных данных.

# Пояснения и комментарии относительно используемых параметров 

Многие значения параметров заданы в программном коде и могут быть переопределены путем простого редактирования.

UniFi контроллер для взаимодействия со внешней средой использует формат обмена данными JSON. Это следует учитывать для понимания принципов работы UniFi Miner.

Тип исследуемого объекта задается строкой и применяется в подавляющем большинстве случаев для отбора объектов JSON по ключу "type". Таким образом, например, при использовании типа "uap" групповая операция count будет применена только к объектам, содержащим данные по UniFi Access Points. Исключение составляет тип 'wlan', который обрабатывается специальным образом для формирования LLD-ответа. Так же стоит отметить, что объекты 'wlan' практически всегда существуют на контроллере, 
что позволяет использовать процедуру получения LLD-ответа для данных объектов в целях отладки.

Внутренний ID объекта генерируется непосредственно контроллером и, похоже, никак не соотносится с какими-либо данными подключенного устройства. Узнать ID конкретного устройства можно из соответствующего LLD-ответа, а так же изучая вывод на консоль при высоком уровне отладки (3).

При использовании контроллера v4 инструментам, использующим API, доступен быстрый путь получения данных объектов, имеющих MAC-адрес. В этом случае указания ID объекта не требуется.

Ключ метрики представляет собой имя ключа JSON-объекта. Увидеть доступные ключи объектов можно при помощи API (https://<unifi:84443>/api/s/default/stat/device) или изучив вывод на консоль при высоком уровне отладки (3). 
Составные ключи представляют из себя конструкцию, состоящую из имени вложенного объекта и ключа. Так, к примеру, составной ключ stat.tx_dropped, означает, что запрашивается метрика ключа tx_dropped, находящегося во вложенном объекте stat.
Так же, существует ключ items_num, не поддерживаемый контроллером, а обрабатываемый специальным образом. Он предназначен для быстрого подсчета количества отобранных объектов, например - количества зарегистрированных UAP.

Несмотря на то, что при помощи опции -l можно указать местонахождение интерфейса контроллера иным, нежели localhost, на мой взгляд продуктивней использовать UniFi Miner на том же хосте, где установлен сам UniFi контроллер. Выигрыш от этого будет наблюдаться на системах, обслуживающих большое количество оборудования (так, как JSON-ответ контроллера будет достаточно большим) или опрашиваемых через публичные или иные высоконагруженные сети.

Некоторые значения ключей предпочтительней обрабатывать на стороне UniFi Miner. В этом случае Zabbix может быстро получить ответы на вопросы: 'сколько точек доступа в пределах сайта находятся в состоянии isolated'. Так, как ключи adopted/isolated/is_guest/etc имеют булеву природу, то количество объектов, находящихся в некотором состоянии, может быть получено простым суммированием значений ключей, отражающих это состояние.

В качестве имени пользователя для доступа к контроллеру через API можно использовать аккаунт администратора, создаваемого при первичной настройке контроллера, но необходимо учитывать, что его пароль служит паролем для доступа по протоколу ssh к физическим устройствам UniFi. В связи с этим разумным выглядит использование для доступа чераз API учетных данных дополнительно созданного на контроллере пользователя.

Значения некоторых ключей (например ng_ast_txto) могут трактоваться неоднозначно - иногда они равны 0, иногда null. Но null (пустая строка, выводимая в stdout) так же возвращается, если задан ошибочный ключ. В связи с этим элементы данных Zabbix, связанные с такими "нестабильными" ключами, переходят в состояние UNSUPPORTED. Для обхода такой ситуации можно использовать опцию -n, с помощью которой заменять null на 0. Но необходимо учитывать, что необдуманное использование данного обходного решения приведет к маскировке реальных проблем и затруднит понимание результатов работы UniFi Miner.

Для ускорения обработки данных, полученных с контроллера, UniFi Miner использует кэширование JSON. При этом также достигается некоторая синхронизация передаваемых Zabbix-серверу значений ключей - например, при достаточном сроке жизни кэша, ответы на последовательные запросы со стороны Zabbix количества клиентов, обслуживаемых точками доступа, будут относиться к одному временному промежутку, а значение их общего количества (сумма), полученное от UniFi Miner совпадет с суммой клиентов, посчитанных на стороне Zabbix. Такое свойство полезно использовать для получения комплексных графиков и составления отчетов.
Значение времени жизни и путь к каталогу, в котором хранятся кэшированные данные, заданы в программном коде и могут быть исправлены. Лучшим местом для хранения кэша, на мой взгляд, является RAM-диск (/run/shm для Linux). В этом случае экземпляр UniFi Miner, запущенный после истечения времени жизни кэша, быстрее обновит его вновь полученными данными. Минимальное время устаревания данных в кэше стоит соотнести с минимальным временем обновления данных в веб-интерфейсе контроллера. Значение параметра равное 0 отключает все процедуры, связанные с кэшированием, а данные запрашиваются напрямую с контроллера.

# Примеры использования UniFi Miner

Получение LLD-ответа для группы объектов по умолчанию 
./unifi_miner.pl

Получение LLD-ответа для группы объектов `точка доступа`
./unifi_miner.pl -o uap

То же самое, но при работе с контроллером v3, находящимся по адресу https://127.0.0.2:8443
./unifi_miner.pl -o uap -v v3 -l https://127.0.0.2:8443

Получение количества UAP, зарегистрированных на контроллере
./unifi_miner.pl -o uap -k items_num

Получение количества UAP, находящихся в состоянии `adopted`
./unifi_miner.pl -o uap -k adopted -a sum

Получение количества клиентов, обслуживаемых на данный момент всеми UAP
./unifi_miner.pl -o uap -k num_sta -a sum

Получение количества клиентов, обслуживаемых на данный момент конкретной UAP
./unifi_miner.pl -o uap -i 5523fe519932508ffaf3b404 -k guest-num_sta

Получение значения ключа tx_dropped, находящегося в таблице (вложенном объекте) stat конкретной UAP
./unifi_miner.pl -o uap -i 5523fe519932508ffaf3b404 -k stat.tx_dropped

Получение версии прошивки (ПО) конкретной UAP 
./unifi_miner.pl -o uap -i 5523fe519932508ffaf3b404 -k version

Получение количества гостевых сетей, обслуживаемых конкретной UAP
./unifi_miner.pl -o uap -i 5523fe519932508ffaf3b404 -k vap_table.is_guest -a sum

Получение имен ключей и внутренних идентификаторов точек доступа
./unifi_miner.pl -o uap -d 3 > report.txt

Получение LLD-ответа для группы объектов `точка доступа` напрямую с контроллера (без учета кэша)
./unifi_miner.pl -o uap -c 0

Получение количества UAP, зарегистрированных на контроллере с проверкой актуальности кэша (60 сек)
./unifi_miner.pl -o uap -k items_num -c 60

Получение самых актуальных данные о количестве клиентов, подключенных на данный момент к UAP с MAC 00:27:22:d8:33:23
./unifi_miner.pl -o uap -m 00:27:22:d8:33:23 -k guest-num_sta -с 0

# Подключение UniFi Miner к Zabbix

Самым простым способом взаимодействия UniFi Miner и Zabbix сервера является использование UserParameter в конфигурационном файле zabbix-агента, установленного на сервере, обслуживающем контроллер UniFi. В этом случае наилучшим вариантом видится применение Linux-версии ПО контроллера.

Например, можно поместить в zabbix_agentd.conf строки:
UserParameter=unifi.discovery[*],/usr/local/bin/zabbix/unifi_miner.pl -o $1 -u $2 -p $3
UserParameter=unifi.uap.state[*],/usr/local/bin/zabbix/unifi_miner.pl -o uap -i $1 -k $2
UserParameter=unifi.site.state[*],/usr/local/bin/zabbix/unifi_miner.pl -o $1 -k $2 -a $3

Затем, создать на Zabbix-сервере элементы данных со следующими ключами:
unifi.discovery[uap, {$USERNAME}, {$PASSWORD}] - для правила LLD, получающего в ответ перечень UAP's.
unifi.uap.state[{#ID}, num_sta] - для прототипа элемента данных LLD, получающего текущее количество клиентов на заданной UAP 
unifi.site.state[uap, isolated, count] - для количества UAP, находящихся в состоянии `isolated`

Как можно видеть выше, данные учетной записи пользователя, имеющего доступ к API контроллера UniFi, такие как имя пользователя и пароль, можно задать через макросы {$USERNAME} и {$PASSWORD}, которые должны быть заведены в Zabbix-сервере на уровне узла. Если вы не желаете передавать в запросе, передающимся по сети в виде простого текста, эти секретные сведения, необходимо соответствующим образом изменить как UserParameter, так и ключ элемента данных Zabbix - убрать все упоминания об опциях -u и -p или указать их значения прямо в zabbix_agentd.conf.
